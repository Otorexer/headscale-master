{% extends "base.html" %}
{% block title %}Pre-Auth Keys{% endblock %}
{% block content %}
<h2>Pre-Auth Keys</h2>
<script>
  if (!localStorage.getItem('token')) {
    window.location.href = '/login';
  }

  let keysData = [];

  async function fetchKeys() {
    try {
      const response = await authFetch(`${API_BASE_URL}/pre_auth_keys`);
      if (!response.ok) {
        throw new Error("Failed to fetch data");
      }
      keysData = await response.json();
      filterAndSortKeys();
    } catch (error) {
      console.error("Error fetching keys:", error);
      alert("Not authorized or error fetching keys.");
    }
  }

  function displayKeys(keys) {
    const tableBody = document.querySelector("#keys-table tbody");
    tableBody.innerHTML = "";
    keys.forEach((k) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${k.id}</td>
        <td>${k.key}</td>
        <td>${k.username}</td>
        <td>${k.reusable ? "Yes" : "No"}</td>
        <td>${k.expiration ? new Date(k.expiration).toLocaleString() : ""}</td>
        <td>
          <button onclick="confirmDeleteKey(${k.id})" style="margin-left: 5px;">Delete</button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  function keyValue(k, field) {
    if (field === "expiration") {
      return k.expiration ? new Date(k.expiration).getTime() : 0;
    }
    return k[field]?.toString().toLowerCase() || "";
  }

  function filterAndSortKeys() {
    const searchTerm = document.querySelector("#search-box").value.toLowerCase();
    const filterBy = document.querySelector("#filter-by").value;
    const sortOrder = document.querySelector("#sort-order").value;

    let filtered = keysData.filter(k => {
      return keyValue(k, filterBy).includes(searchTerm);
    });

    filtered.sort((a, b) => {
      const aVal = keyValue(a, filterBy);
      const bVal = keyValue(b, filterBy);
      if (sortOrder === "asc") {
        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
      } else {
        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
      }
    });
    displayKeys(filtered);
  }

  function confirmDeleteKey(keyId) {
    const confirmation = confirm("Are you sure you want to delete this Pre-Auth Key?");
    if (confirmation) {
      deleteKey(keyId);
    }
  }

  async function deleteKey(keyId) {
    try {
      const response = await authFetch(`${API_BASE_URL}/pre_auth_keys/${keyId}`, {
        method: "DELETE"
      });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || "Failed to delete key");
      }
      alert("Pre-Auth Key deleted successfully!");
      fetchKeys();
    } catch (error) {
      console.error("Error deleting key:", error);
      alert(`Failed to delete key. ${error.message}`);
    }
  }


  document.addEventListener("DOMContentLoaded", () => {
    fetchKeys();
  });
</script>

<!-- Filter Options -->
<div style="margin-bottom: 10px">
  <label for="filter-by" style="margin-right: 10px">Filter By:</label>
  <select id="filter-by" style="padding: 5px" onchange="filterAndSortKeys()">
    <option value="id">ID</option>
    <option value="key">Key</option>
    <option value="username">Username</option>
    <option value="reusable">Reusable</option>
    <option value="expiration">Expiration</option>
  </select>

  <label for="sort-order" style="margin-left: 20px; margin-right: 10px">Sort Order:</label>
  <select id="sort-order" style="padding: 5px" onchange="filterAndSortKeys()">
    <option value="asc">Ascending</option>
    <option value="desc">Descending</option>
  </select>
</div>

<!-- Search Box -->
<input type="text" id="search-box" placeholder="Search..." style="margin-bottom: 10px; width: 100%; padding: 10px"
  oninput="filterAndSortKeys()" />

<!-- Table -->
<table id="keys-table" border="1" style="width: 100%; text-align: left">
  <thead>
    <tr>
      <th>ID</th>
      <th>Key</th>
      <th>Username</th>
      <th>Reusable</th>
      <th>Expiration</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

{% endblock %}